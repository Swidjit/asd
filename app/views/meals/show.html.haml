.row
  .large-8.columns
    .meal[@meal]
      -if @new_item != true
        =form_for @meal do |f|
          =f.text_field :dietary_list, :data => {:pre => @meal.dietary_list.collect{|tag| {:id => tag, :name => tag}}}
          -@dietary_tags.each do |t|
            .tag-suggestion{:value => "dietary"}
              %a= t
          %hr
          =f.text_field :cuisine_list, :data => {:pre => @meal.cuisine_list.collect{|tag| {:id => tag, :name => tag}}}
          -@cuisine_tags.each do |t|
            .tag-suggestion{:value => "cuisine"}
              %a= t
          %hr
          =f.text_field :env_list, :data => {:pre => @meal.env_list.collect{|tag| {:id => tag, :name => tag}}}
          -@env_tags.each do |t|
            .tag-suggestion{:value => "env"}
              %a= t
          %hr
          =f.text_field :location_list, :data => {:pre => @meal.location_list.collect{|tag| {:id => tag, :name => tag}}}
          -@location_tags.each do |t|
            .tag-suggestion{:value => "location"}
              %a= t
          %hr
          =f.submit "add tags", :class => "button"
      %h3=@meal.title
      -if @meal.user == current_user
        =link_to edit_meal_path(@meal) do
          %button edit
      -else

        -if current_user.rsvps.where(:meal_id=>@meal.id).present?
          =link_to meal_rsvps_path(@meal.id), :remote => :true, :method=>:post do
            %button.rsvp cancel rsvp
        -else
          -if @meal.rsvps_count < @meal.dine_in_count
            =link_to meal_rsvps_path(@meal.id), :remote => :true, :method=>:post do
              %button.rsvp rsvp (#{@meal.cost} credits)
        -if current_user.watches.where(:meal_id=>@meal.id).present?
          =link_to meal_watches_path(@meal.id), :remote => :true, :method=>:post do
            %button.watch unwatch
        -else
          =link_to meal_watches_path(@meal.id), :remote => :true, :method=>:post do
            %button.watch watch
      .message
      %p=@meal.description
      -if @meal.dishes.present?
        #dishes.panel
          %h4 dishes
          = render @meal.dishes
      -if @meal.user == current_user
        #new-dish
        %button#add-dish add dish
      %h5 Labels
      -@meal.dietary_list.each do |t|
        =link_to t, meals_path(:dietary=>t)
      %h4 Comments
      .comments
        = render :partial => 'comments/comment', :collection => @comments, :as => :comment
      = render :partial => 'comments/form', :locals => { :comment => @new_comment }
  .large-4.columns
    .panel
      %h4 dinner info
      time
      =@meal.start_time.strftime("%H:%M")
      date
      =@meal.start_time.strftime("%m/%d")
      dine-in seats
      =@meal.dine_in_count
      available seats
      =@meal.dine_in_count - @meal.rsvps_count
      credits
      =@meal.cost


    -if current_user == @meal.user
      %h3 attending
      =render @meal.rsvps

:javascript
  $(document).on('ready page:load', function(){
      $("#meal_dietary_list").tokenInput(
        "#{autocomplete_dietary_search_meals_path}", {
          preventDuplicates:"true",
          minChars: 2,
          theme: "facebook",
          prePopulate: $("#meal_dietary_list").data("pre"),
          onAdd: function(item) {
            item.name = item.name.replace("'","");
          }
        }
      );
    $("#meal_cuisine_list").tokenInput(
      "#{autocomplete_dietary_search_meals_path}", {
        preventDuplicates:"true",
        theme: "facebook",
        prePopulate: $("#meal_cuisine_list").data("pre"),
      }
    );
    $("#meal_location_list").tokenInput(
      "#{autocomplete_dietary_search_meals_path}", {
        preventDuplicates:"true",
        theme: "facebook",
        prePopulate: $("#meal_location_list").data("pre"),
      }
    );
    $("#meal_env_list").tokenInput(
      "#{autocomplete_dietary_search_meals_path}", {
        preventDuplicates:"true",
        theme: "facebook",
        prePopulate: $("#meal_env_list").data("pre"),
      }
    );

    $(".tag-suggestion a").click(function() {

      var tag_list_selector = "#meal_"+$(this).parent().attr("value")+"_list";
      $(tag_list_selector).tokenInput('add', {id: $(this).text(), name: $(this).text()});
      return false
    });
    $('#add-dish').on("click", function() {
      $('#new-dish').html("#{escape_javascript render :partial => 'dishes/new'}");
    });

  });
